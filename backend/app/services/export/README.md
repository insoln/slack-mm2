# export/

В этом модуле реализован экспорт данных в Mattermost. Здесь не должно быть логики парсинга или импорта — только экспорт.

## Архитектура
- Экспорт реализован через оркестратор (см. orchestrator.py), который обрабатывает сущности по очереди: user, custom_emoji, attachment, channel, message, reaction.
- Для каждого типа сущности используется отдельный экспортер (например, UserExporter), реализующий бизнес-логику экспорта.
- HTTP-запросы к Mattermost вынесены в MMApiMixin (mm_api_mixin.py), что позволяет легко переключаться между штатным API и плагином.
- Логирование централизовано через backend_logger.

## Управление статусами
- Все экспортеры наследуют `ExporterBase` с методом `set_status(status, error=None)`
- Статусы обновляются в БД через SQL UPDATE (не INSERT) для корректного отслеживания прогресса
- Поддерживаемые статусы: `pending`, `success`, `failed`, `skipped`
- При ошибке сохраняется `error_message` для диагностики

## Пример: экспорт пользователя
- Все поля Mattermost заполняются из raw_data Slack.
- Если Mattermost возвращает ошибку email_exists или username_exists, экспортер повторно запрашивает пользователя по email/username, записывает его id и считает экспорт успешным.
- Любая другая ошибка фиксируется в error_message, статус становится failed.

## Экспорт кастомных эмодзи
- Требует `mm_user_id` (ID пользователя-владельца токена) для создания эмодзи
- Использует multipart/form-data с полями `image` (файл) и `emoji` (JSON метаданные)
- Поддерживает только PNG, JPEG, GIF форматы
- Имена эмодзи должны быть 1-64 символа, только строчные буквы и цифры

## Переменные окружения
- MM_URL — адрес Mattermost
- MM_TOKEN — токен администратора Mattermost
- EXPORT_WORKERS — количество параллельных воркеров экспорта

## Расширение
- Для других сущностей (каналы, сообщения, реакции и т.д.) архитектура аналогична: реализуется экспортер, добавляется from_entity, используется MMApiMixin.
- Если экспортер требует дополнительные параметры (как `mm_user_id` для эмодзи), они передаются через конструктор.

## Особенности реализации
- Оркестратор получает `mm_user_id` один раз в начале экспорта
- Параметр `mm_user_id` передается только в экспортеры, которые его требуют (например, CustomEmojiExporter)
- Статусы обновляются асинхронно и не блокируют основной поток экспорта

Подробнее см. раздел "Экспорт данных в Mattermost" в backend/README.md 