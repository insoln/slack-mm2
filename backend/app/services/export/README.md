# export/

В этом модуле реализован экспорт данных в Mattermost. Здесь не должно быть логики парсинга или импорта — только экспорт.

## Архитектура
- Экспорт реализован через оркестратор (см. orchestrator.py), который обрабатывает сущности по очереди: user, custom_emoji, channel, attachment, message, reaction.
- Для каждого типа сущности используется отдельный экспортер (например, UserExporter), реализующий бизнес-логику экспорта.
- HTTP-запросы к Mattermost вынесены в MMApiMixin (mm_api_mixin.py), что позволяет легко переключаться между штатным API и плагином.
- Логирование централизовано через backend_logger.

## Управление статусами
- Все экспортеры наследуют `ExporterBase` с методом `set_status(status, error=None)`
- Статусы обновляются в БД через SQL UPDATE (не INSERT) для корректного отслеживания прогресса
- Поддерживаемые статусы: `pending`, `success`, `failed`, `skipped`
- При ошибке сохраняется `error_message` для диагностики

## ChannelExporter — ключевые моменты
- DM и GDM:
  - DM создаются через плагин `/plugins/mm-importer/api/v1/dm` по паре пользователей.
  - Групповые DM (Slack mpim) создаются через `/plugins/mm-importer/api/v1/gdm`. Детекция: `is_mpim` или имя, начинающееся с `mpdm-`.
- Обычные каналы (public/private):
  - Создаются/получаются через `/plugins/mm-importer/api/v1/channel` с нормализацией имени на стороне плагина.
  - `display_name` предварительно санитизируется: удаление CR/LF, обрезка до 64 символов, fallback на name.
  - Тип канала: `O` (public) или `P` (private).
  - Если канал был архивирован в Slack, вызывается `/plugins/mm-importer/api/v1/channel/archive`.
- Членства:
  - Ручная политика: экспортер не добавляет пользователей в команду автоматически. Убедитесь, что нужные пользователи уже состоят в команде до запуска экспорта.
  - Добавление участников в канал выполняется через `/plugins/mm-importer/api/v1/channel/members` (батчом по `user_ids`).
- Team ID:
  - Берётся из `MM_TEAM_ID` или по имени `MM_TEAM` через `/api/v4/teams/name/{name}`; результат кешируется на время экспортера.

## Экспорт кастомных эмодзи
- Требует `mm_user_id` (ID пользователя-владельца токена) для создания эмодзи
- Использует multipart/form-data с полями `image` (файл) и `emoji` (JSON метаданные)
- Поддерживает только PNG, JPEG, GIF форматы
- Имена эмодзи должны быть 1-64 символа, только строчные буквы и цифры

## Переменные окружения
- MM_URL — адрес Mattermost
- MM_TOKEN — токен администратора Mattermost
- MM_TEAM — логическое имя команды (для резолва team_id)
- MM_TEAM_ID — явное указание team_id (опционально; перекрывает MM_TEAM)
- EXPORT_WORKERS — количество параллельных воркеров экспорта

## Расширение
- Для других сущностей (каналы, сообщения, реакции и т.д.) архитектура аналогична: реализуется экспортер, добавляется from_entity, используется MMApiMixin.
- Если экспортер требует дополнительные параметры (как `mm_user_id` для эмодзи), они передаются через конструктор.

## Особенности реализации
- Оркестратор получает `mm_user_id` один раз в начале экспорта
- Параметр `mm_user_id` передается только в экспортеры, которые его требуют (например, CustomEmojiExporter)
- Статусы обновляются асинхронно и не блокируют основной поток экспорта

### MessageExporter
- Формирует POST на `/plugins/mm-importer/api/v1/import` с полями `user_id`, `channel_id`, `message`, `create_at`, `root_id` (опц.), `file_ids` (опц.)
- Канал определяется по связи `posted_in`, автор — по `posted_by` (или по slack_id), вложения собираются по `attached_to`
- Треды: если `thread_ts != ts`, ищется `mattermost_id` родителя и передается как `root_id`

Подробнее см. раздел "Экспорт данных в Mattermost" в backend/README.md 