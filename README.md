# Slack-MM2 Sync

Моно-репозиторий для приложения односторонней синхронизации данных Slack с Mattermost.

## Структура проекта

- `backend/` — Python FastAPI backend, реализующий API, обработку загрузки файлов и webhook.
- `frontend/` — React frontend, UI для загрузки файлов и мониторинга статуса.
- `infra/` — инфраструктура, манифесты Kubernetes, документация по деплою и настройке.

## Cursor instructions

- **Документация**: В каждой директории обязательно должен быть актуальный `README.md` с описанием назначения, структуры и всех поддиректорий.
- **Актуализация**: При любых изменениях в структуре или логике проекта README.md должен быть обновлён.
- **Best practices**: Использовать современные best practices для Python (FastAPI), React (Vite), Kubernetes.
- **Фиксация соглашений**: Все соглашения и инструкции фиксируются в соответствующих README.md.
- **Пример**: Если добавляется новая директория или файл, обязательно добавить/обновить описание в README.md этой директории.
- **Проверка**: Перед коммитом проверять, что документация соответствует текущему состоянию кода и структуры.

## Быстрый старт
(см. README в backend/ и frontend/) 

## Важно
- Все пути к миграциям, SQL-скриптам и данным должны быть относительными (относительно текущего файла или рабочей директории), чтобы проект работал и в Docker, и при локальном запуске. 

## Важно для Docker Compose
- В сервисе backend не используется volume ../backend:/app, чтобы не перекрывать содержимое, скопированное в образ (особенно миграции). Это гарантирует, что проект работает и в Docker Compose, и при ручном запуске/сборке. 

## Структура автотестов (backend)

- `backend/tests/unit/` — юнит-тесты: отдельные функции, классы, утилиты, схемы. Все внешние зависимости мокируются.
- `backend/tests/integration/` — интеграционные тесты: тесты API, взаимодействия с БД, миграций, внешних сервисов.
- `backend/tests/conftest.py` — фикстуры для pytest (например, тестовый клиент FastAPI).

### Запуск тестов
- Юнит-тесты: `pytest backend/tests/unit`
- Интеграционные тесты: `pytest backend/tests/integration` 

## Интеграционные тесты Mattermost API
- Для тестов, обращающихся к Mattermost API, нужны переменные окружения:
  - `MATTERMOST_API_TOKEN` — access token пользователя Mattermost (например, admin)
  - `MATTERMOST_API_URL` — URL эндпоинта API (например, http://localhost:8065/api/v4/users/me)
- Для dev-окружения используйте токен и адрес из init-скрипта или создайте токен через mmctl.
- Для prod — используйте реальные значения из production Mattermost.
- Пример запуска:
  ```bash
  MATTERMOST_API_TOKEN=... MATTERMOST_API_URL=... pytest backend/tests/integration
  ```

## Линтинг и покрытие
- Для проверки стиля используйте black: `black app alembic tests`
- Для запуска тестов с покрытием: `pytest --cov=app --cov-report=term-missing`
- В CI эти проверки выполняются автоматически (см. .github/workflows/backend-ci.yml) 

## Логгирование
- Конфигурация логгирования вынесена в `app/logging_config.py`.
- Формат логов: время, уровень, имя логгера, сообщение.
- Для вывода своих сообщений используйте `from app.logging_config import backend_logger` и `backend_logger.info(...)`.
- Логгирование интегрировано с Uvicorn и поддерживает асинхронные задачи. 

## Запуск тестов: юнит vs интеграционные
- **Юнит-тесты** не требуют запуска внешних сервисов (БД, Mattermost, backend). Их можно запускать где угодно: локально, в CI, без Docker.
- **Интеграционные тесты** требуют, чтобы все внешние сервисы были доступны (backend, Mattermost, БД). Обычно их запускают из-под `docker compose up` или в CI, где все сервисы подняты синхронно.
- Для интеграционных тестов обязательно проверьте, что переменные окружения (`MATTERMOST_API_TOKEN`, `MATTERMOST_API_URL` и др.) указывают на правильные адреса сервисов. 

## Терминология
- **upload** — процесс загрузки файла (например, бэкапа Slack) с фронта на backend.
- **webhook** — приём обновления через вебхук (например, события из Slack в режиме реального времени).
- **parsing** — процедура чтения и разбора полученных данных (как из файла, так и из вебхука).
- **маппинг (mapping)** — одиночная распарсенная строка/объект, представляющая одну сущность (например, сообщение, пользователь, канал и т.д.).
- **импорт (import)** — процедура занесения маппинга в базу данных проекта.
- **экспорт (export)** — процедура отправки данных из маппинга в Mattermost (через API). 